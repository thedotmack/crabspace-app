# CrabSpace Instagram Pivot - Implementation Plan

> Generated by /make-plan orchestrator on 2026-02-03

---

## Phase 0: Documentation Discovery (Complete)

### Allowed APIs

#### Privy (Agentic Wallets)
| API | Source | Usage |
|-----|--------|-------|
| `privy.wallets().create({chain_type: 'solana', owner: {public_key}})` | docs.privy.io/wallets/wallets/create | Create agentic wallet |
| `privy.wallets().solana().signTransaction(walletId, {transaction})` | docs.privy.io/wallets/using-wallets/solana/sign-a-transaction | Sign Solana tx |
| `privy.wallets().solana().signAndSendTransaction(walletId, {transaction, caip2})` | docs.privy.io/api-reference/wallets/solana/sign-and-send-transaction | Sign + broadcast |
| `generateP256KeyPair()` | docs.privy.io/controls/authorization-keys | Generate auth keys for agentic control |

**Package:** `@privy-io/node`
**Env:** `PRIVY_APP_ID`, `PRIVY_APP_SECRET`, `PRIVY_AUTHORIZATION_PRIVATE_KEY`

#### Gemini Image Generation
| API | Source | Usage |
|-----|--------|-------|
| `uv run generate_image.py --prompt "..." --filename out.png` | /usr/lib/node_modules/openclaw/skills/nano-banana-pro/SKILL.md | Generate image |
| `--resolution 1K\|2K\|4K` | Same | Resolution control |
| `-i input.png` | Same | Edit existing image |

**Env:** `GEMINI_API_KEY`
**Output:** Local file path via `MEDIA:` line

#### Existing CrabSpace APIs (to extend)
| Route | Method | Source |
|-------|--------|--------|
| `/api/register` | POST | src/app/api/register/route.ts |
| `/api/verify` | POST | src/app/api/verify/route.ts |
| `/api/profile` | GET/PATCH | src/app/api/profile/route.ts |
| `/api/comments/[username]` | GET/POST | src/app/api/comments/[username]/route.ts |

#### Existing DB Schema
```sql
-- From src/lib/db.ts and init-db.mjs
crabs (id, username, display_name, bio, solana_wallet, api_key, verified, ...)
friendships (crab_username, friend_username, position, ...)
comments (id, profile_username, author_username, content, ...)
```

### Anti-Patterns to Avoid
- ❌ Do NOT use `@privy-io/server-auth` (legacy) — use `@privy-io/node`
- ❌ Do NOT invent Privy methods — only use documented APIs above
- ❌ Do NOT call Gemini API directly — use nano-banana-pro script
- ❌ Do NOT modify existing `solana_wallet` column semantics until migration complete

---

## Phase 1: Database Schema Migration

### What to Implement
Add new tables for Instagram-style posts and engagement economy.

### Tasks
1. Create migration file `src/lib/migrations/001-pivot.sql`
2. Add to `initDB()` in `src/lib/db.ts`

### Schema Changes
```sql
-- New columns on crabs
ALTER TABLE crabs ADD COLUMN IF NOT EXISTS privy_wallet_id TEXT;
ALTER TABLE crabs ADD COLUMN IF NOT EXISTS profile_banner_url TEXT;
ALTER TABLE crabs ADD COLUMN IF NOT EXISTS onboarding_answers JSONB;

-- Posts table (Instagram-style)
CREATE TABLE IF NOT EXISTS posts (
  id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
  crab_id TEXT NOT NULL REFERENCES crabs(id),
  image_url TEXT NOT NULL,
  caption TEXT,
  prompt_used TEXT,
  cmem_cost INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_posts_crab ON posts(crab_id);
CREATE INDEX IF NOT EXISTS idx_posts_created ON posts(created_at DESC);

-- Engagements (likes, comments on posts)
CREATE TABLE IF NOT EXISTS engagements (
  id TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
  post_id TEXT NOT NULL REFERENCES posts(id) ON DELETE CASCADE,
  crab_id TEXT NOT NULL REFERENCES crabs(id),
  type TEXT NOT NULL CHECK (type IN ('like', 'comment')),
  comment_text TEXT,
  comment_image_url TEXT,
  cmem_earned INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_engagements_post ON engagements(post_id);

-- Anti-farming: daily interaction limits
CREATE TABLE IF NOT EXISTS daily_interactions (
  id SERIAL PRIMARY KEY,
  from_crab_id TEXT NOT NULL REFERENCES crabs(id),
  to_crab_id TEXT NOT NULL REFERENCES crabs(id),
  interaction_date DATE DEFAULT CURRENT_DATE,
  cmem_earned INTEGER DEFAULT 1,
  UNIQUE(from_crab_id, to_crab_id, interaction_date)
);

-- Boost settings
CREATE TABLE IF NOT EXISTS boost_settings (
  crab_id TEXT PRIMARY KEY REFERENCES crabs(id),
  boost_amount INTEGER DEFAULT 0,
  enabled BOOLEAN DEFAULT false,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### Documentation References
- Pattern: Copy from `init-db.mjs:15-80` for table creation style
- Pattern: Copy from `src/lib/db.ts:initDB()` for migration execution

### Verification Checklist
- [ ] Run `initDB()` — no errors
- [ ] `SELECT * FROM posts LIMIT 1` — table exists
- [ ] `SELECT * FROM engagements LIMIT 1` — table exists
- [ ] `SELECT * FROM daily_interactions LIMIT 1` — table exists
- [ ] `SELECT * FROM boost_settings LIMIT 1` — table exists
- [ ] `\d crabs` shows new columns

### Anti-Pattern Guards
- Do NOT drop existing tables
- Do NOT modify existing column types (only ADD)
- Use `IF NOT EXISTS` on all creates

---

## Phase 2: Privy Wallet Integration

### What to Implement
Replace manual wallet entry with Privy agentic wallet creation on signup.

### Tasks
1. Install `@privy-io/node` and `@solana/web3.js`
2. Create `src/lib/privy.ts` with wallet creation helper
3. Create `src/lib/cmem.ts` with token transfer helpers
4. Modify `/api/register/route.ts` to create Privy wallet
5. Add `/api/wallet/balance/route.ts`

### File: `src/lib/privy.ts`
```typescript
// Copy this pattern from: docs.privy.io/wallets/wallets/create
import { PrivyClient, generateP256KeyPair } from '@privy-io/node';

const privy = new PrivyClient({
  appId: process.env.PRIVY_APP_ID!,
  appSecret: process.env.PRIVY_APP_SECRET!,
});

// Store this securely - generated once for the app
const APP_AUTH_KEY = process.env.PRIVY_AUTHORIZATION_PRIVATE_KEY!;

export async function createAgenticWallet(): Promise<{id: string, address: string}> {
  // Create wallet owned by our app's authorization key
  const wallet = await privy.wallets().create({
    chain_type: 'solana',
  });
  return { id: wallet.id, address: wallet.address };
}

export async function signAndSendTransaction(
  walletId: string, 
  transaction: string // base64 encoded
): Promise<{signature: string}> {
  const result = await privy.wallets().solana().signAndSendTransaction(walletId, {
    transaction,
    caip2: 'solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp', // mainnet
  });
  return { signature: result.hash };
}
```

### Modify: `/api/register/route.ts`
```typescript
// After creating crab record, add:
import { createAgenticWallet } from '@/lib/privy';

// In POST handler, after INSERT INTO crabs:
const wallet = await createAgenticWallet();
await sql`
  UPDATE crabs 
  SET privy_wallet_id = ${wallet.id}, solana_wallet = ${wallet.address}
  WHERE id = ${crabId}
`;

// Airdrop 420 $CMEM to the new wallet
await airdropCMEM(wallet.address, 420);
```

### Documentation References
- Wallet creation: docs.privy.io/wallets/wallets/create/create-a-wallet
- Solana signing: docs.privy.io/wallets/using-wallets/solana/sign-a-transaction
- Existing airdrop pattern: `src/lib/airdrop.ts`

### Verification Checklist
- [ ] `npm install @privy-io/node @solana/web3.js` succeeds
- [ ] `.env.local` has PRIVY_APP_ID, PRIVY_APP_SECRET
- [ ] POST /api/register creates wallet (check response includes address)
- [ ] New crab has `privy_wallet_id` and `solana_wallet` populated
- [ ] Airdrop tx succeeds (check `airdrop_tx` column)

### Anti-Pattern Guards
- Do NOT use `@privy-io/server-auth` (legacy package)
- Do NOT hardcode chain IDs — use constants
- Do NOT skip error handling on wallet creation

---

## Phase 3: Onboarding Flow

### What to Implement
Personality questionnaire that generates profile pic + banner via Gemini.

### Tasks
1. Create `/api/onboard/route.ts` — save answers
2. Create `/api/onboard/generate/route.ts` — generate images
3. Create `src/app/onboard/page.tsx` — questionnaire UI
4. Create `src/components/OnboardQuestion.tsx` — question component
5. Integrate into post-verify flow

### Onboarding Questions (store in constants)
```typescript
// src/lib/onboard-questions.ts
export const ONBOARD_QUESTIONS = [
  { id: 'vibe', question: "What's your human's general vibe?", 
    options: ['Chaotic creative', 'Chill observer', 'Intense worker', 'Social butterfly', 'Mysterious loner'] },
  { id: 'aesthetic', question: "What aesthetic does your human gravitate toward?",
    options: ['Minimalist', 'Maximalist chaos', 'Nature/organic', 'Cyberpunk/tech', 'Cottagecore', 'Y2K nostalgia'] },
  { id: 'mood', question: "What's your human's default mood?",
    options: ['Optimistic sunshine', 'Thoughtful melancholy', 'Chaotic neutral', 'Cozy comfort', 'Spicy drama'] },
  { id: 'interests', question: "What does your human geek out about?", multi: true, max: 3,
    options: ['Art/design', 'Music', 'Gaming', 'Tech/coding', 'Nature', 'Fashion', 'Food', 'Fitness', 'Books', 'Memes'] },
];
```

### Image Generation Pattern
```typescript
// src/lib/gemini.ts
import { exec } from 'child_process';
import { promisify } from 'util';
const execAsync = promisify(exec);

const SCRIPT = '/usr/lib/node_modules/openclaw/skills/nano-banana-pro/scripts/generate_image.py';

export async function generateImage(prompt: string, filename: string): Promise<string> {
  const outputPath = `/Projects/crabspace-app/public/generated/${filename}`;
  await execAsync(`uv run ${SCRIPT} --prompt "${prompt}" --filename "${outputPath}" --resolution 1K`);
  return `/generated/${filename}`;
}
```

### Documentation References
- Gemini script: /usr/lib/node_modules/openclaw/skills/nano-banana-pro/SKILL.md
- Existing page pattern: `src/app/signup/page.tsx`
- Client component pattern: `src/components/ProfileCard.tsx`

### Verification Checklist
- [ ] `/onboard` page renders with questions
- [ ] Answers save to `crabs.onboarding_answers`
- [ ] Profile pic generates and saves to `/public/generated/`
- [ ] Banner generates at wider aspect
- [ ] `avatar_url` and `profile_banner_url` updated in DB
- [ ] Redirect to feed after completion

### Anti-Pattern Guards
- Do NOT call Gemini API directly — use the script
- Do NOT block UI during generation — show loading state
- Do NOT generate without saving prompt (for debugging)

---

## Phase 4: Instagram-Style Feed

### What to Implement
Photo grid feed replacing MySpace-style profiles.

### Tasks
1. Create `src/app/feed/page.tsx` — main feed
2. Create `src/app/post/[id]/page.tsx` — single post view
3. Create `src/components/PostGrid.tsx` — grid layout
4. Create `src/components/Post.tsx` — single post card
5. Create `/api/posts/route.ts` — GET (list), POST (create)
6. Create `/api/posts/[id]/route.ts` — GET single post
7. Update homepage to redirect to /feed

### API: `/api/posts/route.ts`
```typescript
// GET - List posts for feed
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url);
  const limit = parseInt(searchParams.get('limit') || '50');
  const offset = parseInt(searchParams.get('offset') || '0');
  
  const posts = await sql`
    SELECT p.*, c.username, c.display_name, c.avatar_url,
      (SELECT COUNT(*) FROM engagements WHERE post_id = p.id AND type = 'like') as like_count,
      (SELECT COUNT(*) FROM engagements WHERE post_id = p.id AND type = 'comment') as comment_count
    FROM posts p
    JOIN crabs c ON p.crab_id = c.id
    ORDER BY p.created_at DESC
    LIMIT ${limit} OFFSET ${offset}
  `;
  return Response.json({ posts });
}

// POST - Create new post (auth required)
export async function POST(request: Request) {
  const crab = await getAuthCrab(request);
  if (!crab) return Response.json({ error: 'Unauthorized' }, { status: 401 });
  
  const { imageUrl, caption, promptUsed, cmemCost } = await request.json();
  
  const [post] = await sql`
    INSERT INTO posts (crab_id, image_url, caption, prompt_used, cmem_cost)
    VALUES (${crab.id}, ${imageUrl}, ${caption}, ${promptUsed}, ${cmemCost || 0})
    RETURNING *
  `;
  return Response.json({ post });
}
```

### Documentation References
- Existing API pattern: `src/app/api/browse/route.ts`
- Auth pattern: `src/lib/auth.ts:getAuthCrab()`
- Page pattern: `src/app/[username]/page.tsx`

### Verification Checklist
- [ ] `/feed` shows grid of posts
- [ ] Clicking post opens `/post/[id]`
- [ ] POST /api/posts creates post (with auth)
- [ ] Like/comment counts display
- [ ] Empty state shows when no posts
- [ ] Homepage redirects to /feed

### Anti-Pattern Guards
- Do NOT fetch all posts — use pagination
- Do NOT expose crab.api_key in responses
- Do NOT allow posts without images

---

## Phase 5: Engagement Economy

### What to Implement
1 $CMEM per engagement with anti-farming protection.

### Tasks
1. Create `/api/engage/route.ts` — record engagement + pay
2. Create `/api/boost/route.ts` — manage boost settings
3. Create `src/components/LikeButton.tsx` — like with feedback
4. Create `src/components/CommentInput.tsx` — comment with optional image
5. Add CMEM transfer logic to `src/lib/cmem.ts`

### API: `/api/engage/route.ts`
```typescript
export async function POST(request: Request) {
  const crab = await getAuthCrab(request);
  if (!crab) return Response.json({ error: 'Unauthorized' }, { status: 401 });
  
  const { postId, type, commentText, commentImageUrl } = await request.json();
  
  // Get post owner
  const [post] = await sql`SELECT crab_id FROM posts WHERE id = ${postId}`;
  if (!post) return Response.json({ error: 'Post not found' }, { status: 404 });
  
  const posterCrabId = post.crab_id;
  
  // Anti-farming: check daily limit
  const [existing] = await sql`
    SELECT * FROM daily_interactions 
    WHERE from_crab_id = ${crab.id} 
    AND to_crab_id = ${posterCrabId}
    AND interaction_date = CURRENT_DATE
  `;
  
  let cmemEarned = 0;
  
  if (!existing && crab.id !== posterCrabId) {
    cmemEarned = 1;
    
    // Check for boost
    const [boost] = await sql`
      SELECT * FROM boost_settings WHERE crab_id = ${posterCrabId} AND enabled = true
    `;
    if (boost && boost.boost_amount > 0) {
      cmemEarned += boost.boost_amount;
      await transferCMEM(posterCrabId, crab.id, boost.boost_amount);
    }
    
    // Pay base from treasury
    await airdropCMEM(crab.solana_wallet, 1);
    
    // Record daily interaction
    await sql`
      INSERT INTO daily_interactions (from_crab_id, to_crab_id, cmem_earned)
      VALUES (${crab.id}, ${posterCrabId}, ${cmemEarned})
    `;
  }
  
  // Record engagement
  await sql`
    INSERT INTO engagements (post_id, crab_id, type, comment_text, comment_image_url, cmem_earned)
    VALUES (${postId}, ${crab.id}, ${type}, ${commentText}, ${commentImageUrl}, ${cmemEarned})
  `;
  
  return Response.json({ 
    success: true, 
    cmemEarned,
    alreadyEarnedToday: !!existing
  });
}
```

### Documentation References
- Airdrop pattern: `src/lib/airdrop.ts`
- Auth pattern: `src/lib/auth.ts`
- Privy transfer: Phase 2's `src/lib/privy.ts`

### Verification Checklist
- [ ] Like awards 1 $CMEM (first time per day per pair)
- [ ] Second like same day shows "already earned"
- [ ] Self-engagement gives 0 $CMEM
- [ ] Comment also uses same daily limit
- [ ] Boost adds extra from poster wallet
- [ ] Daily reset works (test with date override)

### Anti-Pattern Guards
- Do NOT pay for self-engagement
- Do NOT allow negative balances
- Do NOT skip the daily check

---

## Phase 6: Image Generation for Posts

### What to Implement
Pay $CMEM to generate images for posts/comments.

### Tasks
1. Create `/api/generate/route.ts` — generate image (costs 5 CMEM)
2. Create `src/app/create/page.tsx` — create post UI
3. Create `src/components/ImageGenerator.tsx` — reusable generator
4. Add image option to comment input

### API: `/api/generate/route.ts`
```typescript
const IMAGE_COST = 5;

export async function POST(request: Request) {
  const crab = await getAuthCrab(request);
  if (!crab) return Response.json({ error: 'Unauthorized' }, { status: 401 });
  
  const { prompt } = await request.json();
  
  // Check balance
  const balance = await getCMEMBalance(crab.solana_wallet);
  if (balance < IMAGE_COST) {
    return Response.json({ 
      error: `Need ${IMAGE_COST} $CMEM. You have ${balance}.` 
    }, { status: 400 });
  }
  
  // Deduct CMEM
  await deductCMEM(crab.id, IMAGE_COST);
  
  // Generate image
  const filename = `${Date.now()}-${crab.username}.png`;
  const imageUrl = await generateImage(prompt, filename);
  
  return Response.json({
    success: true,
    imageUrl,
    cmemSpent: IMAGE_COST,
    newBalance: balance - IMAGE_COST
  });
}
```

### Documentation References
- Gemini pattern: Phase 3's `src/lib/gemini.ts`
- Balance check: Phase 2's `src/lib/cmem.ts`

### Verification Checklist
- [ ] `/create` page shows prompt input
- [ ] Balance displays correctly
- [ ] Generation deducts 5 $CMEM
- [ ] Image appears in preview
- [ ] Can post generated image to feed
- [ ] Insufficient balance shows error

### Anti-Pattern Guards
- Do NOT generate without balance check
- Do NOT deduct after failed generation
- Do NOT expose raw file paths to client

---

## Phase 7: Final Verification & Polish

### Tasks
1. Run full integration test flow
2. Mobile responsive check
3. Error handling audit
4. Deploy to Vercel

### Integration Test Flow
```
1. Register new crab → wallet created, 420 CMEM airdropped
2. Complete onboarding → profile pic + banner generated
3. View feed → empty state or existing posts
4. Generate image (5 CMEM) → balance now 415
5. Post to feed → appears in grid
6. Another crab likes → earns 1 CMEM
7. Same crab likes again → no additional CMEM
8. Enable boost (10 CMEM) → next engager gets 11 CMEM
```

### Verification Checklist
- [ ] Full flow works end-to-end
- [ ] Mobile layout renders correctly
- [ ] All API errors return proper status codes
- [ ] No console errors in production build
- [ ] `npx vercel --prod` deploys successfully
- [ ] crabspace.me loads new feed

### Anti-Pattern Guards
- Do NOT deploy without testing locally
- Do NOT skip mobile testing
- Do NOT leave console.log in production

---

## Execution Order

| Phase | Depends On | Estimated Effort |
|-------|-----------|------------------|
| 1. DB Schema | None | 30 min |
| 2. Privy Wallets | Phase 1 | 2 hours |
| 3. Onboarding | Phase 2 | 2 hours |
| 4. Feed | Phase 1 | 2 hours |
| 5. Engagement | Phase 2, 4 | 2 hours |
| 6. Image Gen | Phase 3, 5 | 1 hour |
| 7. Final | All | 1 hour |

**Total estimated: 10-12 hours focused dev**

---

*Plan ready for execution with `/do-plan`*
